<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高機能メモ帳アプリ</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ** IMPORTANT: This script enables dark mode for Tailwind CSS ** -->
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <style>
        /* Custom styles for the editor and overall look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Style for the contenteditable editor */
        #editor {
            min-height: 400px;
            outline: none;
            line-height: 1.6;
        }
        
        /* Animation for modals */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 300ms, transform 300ms;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 transition-colors duration-300">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-6">
        
        <!-- Header Section -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200 dark:border-slate-700">
            <h1 class="text-3xl font-bold text-slate-900 dark:text-slate-100 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-notebook-tabs mr-3 text-blue-600"><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M15 2v20"/><path d="M15 7h5"/><path d="M15 12h5"/><path d="M15 17h5"/></svg>
                メモ帳アプリ
            </h1>
            <div class="flex items-center gap-2">
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 17.66 1.41-1.41"/><path d="m17.66 4.93 1.41-1.41"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </button>
                <!-- Google Drive Authentication Buttons -->
                <button id="authorize_button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all duration-200">Google Driveにサインイン</button>
                <button id="signout_button" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all duration-200">サインアウト</button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Home View: List of notes and folders -->
            <div id="home-view">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <div id="breadcrumb" class="text-lg font-medium text-slate-600 dark:text-slate-400"></div>
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <select id="sort-select" class="appearance-none bg-white border border-slate-300 rounded-md py-2 pl-3 pr-8 text-sm leading-5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-200">
                                <option value="createdAt_desc">作成日順（新しい順）</option>
                                <option value="createdAt_asc">作成日順（古い順）</option>
                                <option value="title_asc">名前順（昇順）</option>
                                <option value="title_desc">名前順（降順）</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700 dark:text-slate-300">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                        <button id="create-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 shadow-sm transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            <span>作成</span>
                        </button>
                    </div>
                </div>
                <div id="items-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Items will be dynamically inserted here -->
                </div>
                 <div id="empty-state" class="hidden text-center py-16">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-plus-2 mx-auto text-slate-400 dark:text-slate-500 mb-4"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M3 15h6"/><path d="M6 12v6"/></svg>
                    <p class="text-slate-500 dark:text-slate-400">アイテムがありません。</p>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mt-1">「作成」ボタンから新しいメモやフォルダを追加しましょう。</p>
                </div>
            </div>

            <!-- Editor View -->
            <div id="editor-view" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <button id="back-to-home" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-all duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                        戻る
                    </button>
                    <div id="sync-status" class="text-sm text-slate-500 dark:text-slate-400"></div>
                </div>
                <input type="text" id="note-title" placeholder="タイトルを入力..." class="text-3xl font-bold w-full p-2 mb-4 bg-transparent border-b-2 border-slate-200 dark:border-slate-700 focus:outline-none focus:border-blue-500 dark:focus:border-blue-500 transition-colors dark:text-slate-100">
                
                <!-- Editor Toolbar -->
                <div class="flex items-center flex-wrap gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-t-lg border border-b-0 border-slate-200 dark:border-slate-700">
                    <button class="editor-tool-btn flex items-center justify-center p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700" data-command="bold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bold"><path d="M14 12a4 4 0 0 0 0-8H6v8"/><path d="M15 20a4 4 0 0 0 0-8H6v8Z"/></svg>
                    </button>
                    <button class="editor-tool-btn flex items-center justify-center p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700" data-command="italic">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-italic"><line x1="19" x2="10" y1="4" y2="4"/><line x1="14" x2="5" y1="20" y2="20"/><line x1="15" x2="9" y1="4" y2="20"/></svg>
                    </button>
                    <button id="create-link-btn" class="editor-tool-btn flex items-center justify-center p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>
                    </button>
                    <div class="w-px h-6 bg-slate-300 dark:bg-slate-600 mx-2"></div>
                    <button class="editor-tool-btn flex items-center justify-center p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700" data-command="undo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-undo-2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a8.5 8.5 0 1 1-4.13 15.87"/></svg>
                    </button>
                    <button class="editor-tool-btn flex items-center justify-center p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700" data-command="redo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-redo-2"><path d="M15 14 20 9l-5-5"/><path d="M20 9H9.5A8.5 8.5 0 1 0 13.6 21.8"/></svg>
                    </button>
                </div>
                
                <!-- The actual editor area -->
                <div id="editor" contenteditable="true" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-4 rounded-b-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"></div>
            </div>
        </main>
    </div>

    <!-- Create New Item Modal -->
    <div id="create-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm modal-enter">
            <h3 class="text-xl font-bold mb-6 text-center dark:text-slate-100">新規作成</h3>
            <div class="flex justify-around">
                <button id="create-note-btn" class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors w-32">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text text-blue-500"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                    <span class="font-semibold dark:text-slate-200">メモ</span>
                </button>
                <button id="create-folder-btn" class="flex flex-col items-center gap-3 p-4 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors w-32">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder-plus text-yellow-500"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><path d="M12 10v6"/><path d="M9 13h6"/></svg>
                    <span class="font-semibold dark:text-slate-200">フォルダ</span>
                </button>
            </div>
            <button id="cancel-create-btn" class="mt-6 w-full bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-bold py-2 px-4 rounded-lg transition-colors">キャンセル</button>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm modal-enter">
            <h3 class="text-xl font-bold mb-2 text-center dark:text-slate-100">アイテムの削除</h3>
            <p class="text-slate-600 dark:text-slate-400 mb-6 text-center">本当に削除しますか？<br>この操作は取り消せません。</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-bold py-2 px-4 rounded-lg transition-colors w-32">キャンセル</button>
                <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-32">削除</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="rename-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm modal-enter">
            <h3 class="text-xl font-bold mb-4 text-center dark:text-slate-100">名前の変更</h3>
            <input type="text" id="rename-input" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md dark:bg-slate-700 dark:text-slate-200">
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-rename-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-bold py-2 px-4 rounded-lg transition-colors w-32">キャンセル</button>
                <button id="confirm-rename-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-32">変更</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div id="link-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm modal-enter">
            <h3 class="text-xl font-bold mb-4 text-center dark:text-slate-100">ハイパーリンクの挿入</h3>
            <div class="space-y-4">
                <div>
                    <label for="link-text" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">表示するテキスト</label>
                    <input type="text" id="link-text" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md dark:bg-slate-700 dark:text-slate-200">
                </div>
                <div>
                    <label for="link-url" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">URL</label>
                    <input type="url" id="link-url" placeholder="https://example.com" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-md dark:bg-slate-700 dark:text-slate-200">
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="cancel-link-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-bold py-2 px-4 rounded-lg transition-colors w-32">キャンセル</button>
                <button id="confirm-link-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors w-32">OK</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Google Drive API Configuration ---
        const API_KEY = 'AIzaSyBLmHIWLuc2_wTHx3K1oochmJA1y8VMhdQ'; 
        const CLIENT_ID = '781525780297-6g46pbeldee9lpfrq6lrg9qlc5qalegb.apps.googleusercontent.com';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const APP_FILENAME = 'my-notepad-app-data.json';
        let driveFileId = null;

        // --- DOM Elements ---
        const homeView = document.getElementById('home-view');
        const editorView = document.getElementById('editor-view');
        const itemsList = document.getElementById('items-list');
        const createBtn = document.getElementById('create-btn');
        const backToHomeBtn = document.getElementById('back-to-home');
        const editor = document.getElementById('editor');
        const noteTitleInput = document.getElementById('note-title');
        const sortSelect = document.getElementById('sort-select');
        const breadcrumb = document.getElementById('breadcrumb');
        const emptyState = document.getElementById('empty-state');
        const syncStatus = document.getElementById('sync-status');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        
        // Modals
        const createModal = document.getElementById('create-modal');
        const createNoteBtn = document.getElementById('create-note-btn');
        const createFolderBtn = document.getElementById('create-folder-btn');
        const cancelCreateBtn = document.getElementById('cancel-create-btn');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const renameModal = document.getElementById('rename-modal');
        const renameInput = document.getElementById('rename-input');
        const cancelRenameBtn = document.getElementById('cancel-rename-btn');
        const confirmRenameBtn = document.getElementById('confirm-rename-btn');
        const linkModal = document.getElementById('link-modal');
        const linkTextInput = document.getElementById('link-text');
        const linkUrlInput = document.getElementById('link-url');
        const cancelLinkBtn = document.getElementById('cancel-link-btn');
        const confirmLinkBtn = document.getElementById('confirm-link-btn');
        const createLinkBtn = document.getElementById('create-link-btn');


        // Google Auth Buttons
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');

        // --- Application State ---
        let state = {
            items: [],
            currentView: 'home',
            currentParentId: null,
            editingItemId: null,
            sortBy: 'createdAt_desc',
            isGapiReady: false,
            isGsiReady: false,
            tokenClient: null,
            deleteCandidateId: null,
            renameCandidateId: null,
        };
        
        let saveTimeout;
        let savedSelection = null;

        const generateUUID = () => crypto.randomUUID();

        // --- Data Persistence ---
        const saveData = async () => {
            // Always save to local storage as a backup
            localStorage.setItem('memoAppData', JSON.stringify(state.items));
            
            // If signed into Google Drive, save there as well
            if (gapi.client?.getToken && gapi.client.getToken() && driveFileId) {
                setSyncStatus('保存中...');
                try {
                    await saveToDrive();
                    setSyncStatus('Google Driveに保存済み');
                } catch (error) {
                    console.error('Error saving to Google Drive:', error);
                    setSyncStatus('Driveへの保存に失敗');
                }
            }
        };

        // --- Google Drive Integration ---
        const gapiLoaded = () => gapi.load('client', initializeGapiClient);

        const initializeGapiClient = async () => {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            state.isGapiReady = true;
            updateAuthButtons();
            // If a token exists, it means the user was previously signed in.
            // Automatically try to load their data from Drive.
            if (gapi.client.getToken()) {
                await loadFromDrive();
            }
        };

        const gisLoaded = () => {
            state.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Callback is handled dynamically
            });
            state.isGsiReady = true;
            updateAuthButtons();
        };

        const handleAuthClick = () => {
            if (API_KEY === 'YOUR_API_KEY' || CLIENT_ID === 'YOUR_CLIENT_ID') {
                alert('Google Drive連携機能を使用するには、コード内のAPI_KEYとCLIENT_IDを設定してください。');
                return;
            }
            if (!state.tokenClient) return;

            state.tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) throw (resp);
                updateAuthButtons();
                await loadFromDrive(); // Load data after successful sign-in
            };

            // Prompt the user for consent if they are not already signed in
            if (gapi.client.getToken() === null) {
                state.tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                state.tokenClient.requestAccessToken({ prompt: '' });
            }
        };

        const handleSignoutClick = () => {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                driveFileId = null;
                updateAuthButtons();
                setSyncStatus('');
            }
        };

        const updateAuthButtons = () => {
            if (!gapi.client) return;
            const token = gapi.client.getToken();
            if (token) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
            } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
            }
        };

        const findOrCreateAppFile = async () => {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${APP_FILENAME}' and mimeType='application/json' and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive',
                });
                if (response.result.files && response.result.files.length > 0) {
                    driveFileId = response.result.files[0].id;
                } else {
                    const createResponse = await gapi.client.drive.files.create({
                        resource: { name: APP_FILENAME, mimeType: 'application/json' },
                        fields: 'id',
                    });
                    driveFileId = createResponse.result.id;
                    // Save current (potentially empty or local) data to the new file
                    await saveToDrive(); 
                }
            } catch (error) {
                console.error('Error finding or creating app file:', error);
            }
        };

        const saveToDrive = async () => {
            if (!driveFileId) return;
            const content = JSON.stringify(state.items);
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            const metadata = { 'mimeType': 'application/json' };
            const multipartRequestBody = delimiter + 'Content-Type: application/json\r\n\r\n' + JSON.stringify(metadata) + delimiter + 'Content-Type: application/json\r\n\r\n' + content + close_delim;
            await gapi.client.request({
                path: `/upload/drive/v3/files/${driveFileId}`,
                method: 'PATCH',
                params: { uploadType: 'multipart' },
                headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                body: multipartRequestBody,
            });
        };

        const loadFromDrive = async () => {
            await findOrCreateAppFile();
            if (!driveFileId) return;
            setSyncStatus('Google Driveから読込中...');
            try {
                const response = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                const driveData = response.result;
                // Check if the file has content and is a valid array
                if (Array.isArray(driveData)) {
                    state.items = driveData;
                    localStorage.setItem('memoAppData', JSON.stringify(state.items));
                    render();
                }
                setSyncStatus('Google Driveと同期済み');
            } catch (error) {
                console.error('Error loading from Drive:', error);
                setSyncStatus('Driveからの読込に失敗');
                // If loading fails, fall back to local data
                loadLocalData();
                render();
            }
        };

        const loadLocalData = () => {
            const localData = localStorage.getItem('memoAppData');
            if (localData) {
                try { 
                    state.items = JSON.parse(localData); 
                } catch (e) { 
                    console.error("Error parsing local data:", e); 
                    state.items = []; 
                }
            }
        };

        // --- Rendering Functions ---
        const render = () => {
            if (state.currentView === 'home') {
                homeView.classList.remove('hidden');
                editorView.classList.add('hidden');
                renderItemsList();
                updateBreadcrumb();
            } else {
                homeView.classList.add('hidden');
                editorView.classList.remove('hidden');
                renderEditor();
            }
        };
        
        const renderItemsList = () => {
            itemsList.innerHTML = '';
            const filteredItems = state.items.filter(item => item.parentId === state.currentParentId);
            emptyState.classList.toggle('hidden', filteredItems.length > 0);

            const sortedItems = [...filteredItems].sort((a, b) => {
                if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                const [key, order] = state.sortBy.split('_');
                const valA = a[key];
                const valB = b[key];
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            sortedItems.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md hover:border-blue-400 dark:hover:border-blue-500 transition-all duration-200 cursor-pointer relative group';
                itemEl.dataset.id = item.id;

                const isFolder = item.type === 'folder';
                const icon = isFolder 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder mb-2 text-yellow-500"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text mb-2 text-blue-500"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>`;
                
                const pinIconColor = item.isPinned ? 'text-yellow-400' : 'text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300';
                
                const editButtonHTML = `<button class="edit-btn p-1.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil text-slate-400 hover:text-blue-500 dark:hover:text-blue-400"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>`;

                itemEl.innerHTML = `
                    ${icon}
                    <h3 class="font-semibold truncate text-slate-800 dark:text-slate-200">${item.title || '無題'}</h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${new Date(item.createdAt).toLocaleString('ja-JP')}</p>
                    <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        ${editButtonHTML}
                        <button class="pin-btn p-1.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="${pinIconColor}"><path d="M16 3.1c-.6-1-1.8-1.4-2.8-1.1-1 .3-1.8 1.1-2.1 2.1-.3 1 .1 2.2 1.1 2.8l-5.6 5.6c-.4.4-.4 1 0 1.4l2.8 2.8c.4.4 1 .4 1.4 0l5.6-5.6c.7.9 1.8 1.2 2.8 1.1 1-.3 1.8-1.1 2.1-2.1.3-1-.1-2.2-1.1-2.8L16 3.1zM12 8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg></button>
                        <button class="delete-btn p-1.5 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" data-id="${item.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-slate-400 hover:text-red-500"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg></button>
                    </div>`;
                
                itemEl.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-btn, .pin-btn, .edit-btn')) return;
                    handleItemClick(item.id);
                });
                itemsList.appendChild(itemEl);
            });
        };

        const renderEditor = () => {
            const item = state.items.find(i => i.id === state.editingItemId);
            if (item) {
                noteTitleInput.value = item.title;
                editor.innerHTML = item.content || '';
            }
        };

        const updateBreadcrumb = () => {
            const path = [];
            let currentId = state.currentParentId;

            while (currentId) {
                const parent = state.items.find(item => item.id === currentId);
                if (parent) {
                    path.unshift({ id: parent.id, title: parent.title });
                    currentId = parent.parentId;
                } else {
                    break; 
                }
            }

            path.unshift({ id: null, title: 'ホーム' });

            breadcrumb.innerHTML = path.map((p, index) => {
                if (index === path.length - 1) {
                    return `<span class="font-bold text-slate-800 dark:text-slate-200">${p.title}</span>`;
                }
                return `<a href="#" class="hover:underline text-blue-600 dark:text-blue-400" data-id="${p.id}">${p.title}</a>`;
            }).join('<span class="mx-2 text-slate-400 dark:text-slate-500">/</span>');
        };


        // --- Event Handlers & Logic ---
        const handleItemClick = (id) => {
            const item = state.items.find(i => i.id === id);
            if (!item) return;
            
            if (item.type === 'folder') {
                state.currentParentId = id;
            } else {
                state.editingItemId = id;
                state.currentView = 'editor';
            }
            render();
        };

        const createItem = (type) => {
            const newItem = {
                id: generateUUID(),
                type: type,
                title: type === 'folder' ? '新しいフォルダ' : '無題のメモ',
                content: '',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                isPinned: false,
                parentId: state.currentParentId,
            };
            state.items.push(newItem);
            saveData();
            
            if (type === 'note') {
                state.editingItemId = newItem.id;
                state.currentView = 'editor';
            }
            render();
        };
        
        const updateNote = () => {
            const item = state.items.find(i => i.id === state.editingItemId);
            if (item) {
                item.title = noteTitleInput.value;
                item.content = editor.innerHTML;
                item.updatedAt = new Date().toISOString();
                
                clearTimeout(saveTimeout);
                setSyncStatus('変更あり');
                saveTimeout = setTimeout(() => saveData(), 1000);
            }
        };

        const updateToolbarState = () => {
            if (state.currentView !== 'editor') return;
            try {
                const isBold = document.queryCommandState('bold');
                const isItalic = document.queryCommandState('italic');

                const boldBtn = document.querySelector('.editor-tool-btn[data-command="bold"]');
                const italicBtn = document.querySelector('.editor-tool-btn[data-command="italic"]');

                boldBtn.classList.toggle('bg-blue-200', isBold);
                boldBtn.classList.toggle('dark:bg-blue-700', isBold);

                italicBtn.classList.toggle('bg-blue-200', isItalic);
                italicBtn.classList.toggle('dark:bg-blue-700', isItalic);
            } catch (e) {
                console.error("Could not update toolbar state:", e);
            }
        };
        
        const setSyncStatus = (text) => syncStatus.textContent = text;
        
        const showModal = (modal) => {
            modal.classList.remove('hidden');
            modal.querySelector('div').classList.add('modal-enter-active');
            modal.querySelector('div').classList.remove('modal-enter');
        };
        
        const hideModal = (modal) => {
            const content = modal.querySelector('div');
            content.classList.add('modal-exit-active');
            content.classList.remove('modal-enter-active');
            setTimeout(() => {
                modal.classList.add('hidden');
                content.classList.remove('modal-exit-active');
            }, 300);
        };

        // --- Event Listeners ---
        createBtn.addEventListener('click', () => {
            if (state.currentParentId !== null) {
                createFolderBtn.style.display = 'none';
            } else {
                createFolderBtn.style.display = 'flex';
            }
            showModal(createModal);
        });
        cancelCreateBtn.addEventListener('click', () => hideModal(createModal));
        createNoteBtn.addEventListener('click', () => { hideModal(createModal); createItem('note'); });
        createFolderBtn.addEventListener('click', () => { hideModal(createModal); createItem('folder'); });

        backToHomeBtn.addEventListener('click', () => {
            state.currentView = 'home';
            state.editingItemId = null;
            render();
        });

        noteTitleInput.addEventListener('input', updateNote);
        editor.addEventListener('input', updateNote);
        sortSelect.addEventListener('change', (e) => { state.sortBy = e.target.value; render(); });

        document.querySelectorAll('.editor-tool-btn[data-command]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.execCommand(btn.dataset.command, false, null);
                editor.focus();
                updateNote();
                updateToolbarState(); // Update toolbar after command
            });
        });

        createLinkBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                savedSelection = selection.getRangeAt(0).cloneRange();
                linkTextInput.value = selection.toString();
            } else {
                savedSelection = null;
                linkTextInput.value = '';
            }
            linkUrlInput.value = '';
            showModal(linkModal);
            linkUrlInput.focus();
        });

        confirmLinkBtn.addEventListener('click', () => {
            let url = linkUrlInput.value.trim();
            let text = linkTextInput.value.trim();

            if (!url || !text) return;

            if (!/^https?:\/\//i.test(url)) {
                url = 'https://' + url;
            }
            
            editor.focus();

            if (savedSelection) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedSelection);
            }
            
            const linkHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
            document.execCommand('insertHTML', false, linkHTML);
            
            updateNote();
            hideModal(linkModal);
            savedSelection = null;
        });

        cancelLinkBtn.addEventListener('click', () => {
            hideModal(linkModal);
            savedSelection = null;
        });

        linkUrlInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                confirmLinkBtn.click();
            } else if (e.key === 'Escape') {
                cancelLinkBtn.click();
            }
        });


        // Add listeners to update the toolbar state based on cursor position
        editor.addEventListener('keyup', updateToolbarState);
        editor.addEventListener('mouseup', updateToolbarState);
        editor.addEventListener('focus', updateToolbarState);
        document.addEventListener('selectionchange', () => {
            if (document.activeElement === editor) {
                updateToolbarState();
            }
        });

        breadcrumb.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                const id = link.dataset.id;
                state.currentParentId = id === 'null' ? null : id;
                render();
            }
        });

        itemsList.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('.pin-btn, .delete-btn, .edit-btn');
            if (!targetBtn) return;
            
            e.preventDefault();
            e.stopPropagation();

            const id = targetBtn.dataset.id;
            
            if (targetBtn.classList.contains('pin-btn')) {
                const item = state.items.find(i => i.id === id);
                if (item) {
                    item.isPinned = !item.isPinned;
                    saveData();
                    render();
                }
            } else if (targetBtn.classList.contains('delete-btn')) {
                state.deleteCandidateId = id;
                showModal(deleteModal);
            } else if (targetBtn.classList.contains('edit-btn')) {
                const itemToEdit = state.items.find(i => i.id === id);
                if (!itemToEdit) return;
                state.renameCandidateId = id;
                renameInput.value = itemToEdit.title;
                showModal(renameModal);
                renameInput.focus();
                renameInput.select();
            }
        });
        
        cancelDeleteBtn.addEventListener('click', () => { hideModal(deleteModal); state.deleteCandidateId = null; });
        confirmDeleteBtn.addEventListener('click', () => {
            if (state.deleteCandidateId) {
                const deleteIds = [state.deleteCandidateId];
                const findChildren = (parentId) => {
                    state.items.forEach(item => {
                        if (item.parentId === parentId) {
                            deleteIds.push(item.id);
                            if (item.type === 'folder') findChildren(item.id);
                        }
                    });
                };
                findChildren(state.deleteCandidateId);
                
                state.items = state.items.filter(item => !deleteIds.includes(item.id));
                saveData();
                render();
            }
            hideModal(deleteModal);
            state.deleteCandidateId = null;
        });

        cancelRenameBtn.addEventListener('click', () => {
            hideModal(renameModal);
            state.renameCandidateId = null;
        });

        confirmRenameBtn.addEventListener('click', () => {
            if (!state.renameCandidateId) return;
            const itemToUpdate = state.items.find(i => i.id === state.renameCandidateId);
            const newTitle = renameInput.value.trim();

            if (itemToUpdate && newTitle && newTitle !== itemToUpdate.title) {
                itemToUpdate.title = newTitle;
                itemToUpdate.updatedAt = new Date().toISOString();
                saveData();
                render();
            }
            hideModal(renameModal);
            state.renameCandidateId = null;
        });

        renameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                confirmRenameBtn.click();
            } else if (e.key === 'Escape') {
                cancelRenameBtn.click();
            }
        });
        
        authorizeButton.addEventListener('click', handleAuthClick);
        signoutButton.addEventListener('click', handleSignoutClick);
        
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            themeIconLight.classList.toggle('hidden', isDark);
            themeIconDark.classList.toggle('hidden', !isDark);
        });

        // --- Initialization ---
        const init = () => {
            loadLocalData();
            
            const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            
            themeIconLight.classList.toggle('hidden', isDark);
            themeIconDark.classList.toggle('hidden', !isDark);
            
            render();

            // Dynamically load Google API scripts
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = gapiLoaded;
            document.body.appendChild(gapiScript);

            const gsiScript = document.createElement('script');
            gsiScript.src = 'https://accounts.google.com/gsi/client';
            gsiScript.onload = gisLoaded;
            document.body.appendChild(gsiScript);
        };

        init();
    });
    </script>
</body>
</html>
